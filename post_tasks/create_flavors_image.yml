---
- name: Create customized flavors and image
  hosts: undercloud
  gather_facts: no
  tasks:
      - name: Create compute flavors
        vars:
            ansible_python_interpreter: "/var/tmp/venv_shade/bin/python"
        os_nova_flavor:
            validate_certs: no
            cloud: overcloud
            state: present
            name: "{{ item.name }}"
            ram: "{{ install.workload.memory }}"
            vcpus: "{{ install.workload.vcpu }}"
            disk: "{{ install.workload.disk }}"
            flavorid: "{{ item.flavorid }}"
            extra_specs: "{{ install.workload.flavor.extra.specs }}"
        loop:
            - { name: customized_flavor, flavorid: "{{ install.workload.flavorid }}" }
            - { name: customized_flavor_alt, flavorid: "{{ (install.workload.flavorid|int + 1 )|string }}" }
        delegate_to: "{{ groups.shade | first }}"

      - name: Create image
        block:
            - name: Set hostname url
              set_fact:
                  hostname_url: "{{ install.image | basename }}"

            - name: Download image
              get_url:
                  url: "{{ install.image }}"
                  dest: "/tmp/{{ hostname_url }}"

            - name: Upload {{ hostname_url }} image
              shell: |
                  source {{ ansible_user_dir }}/{{ install.overcloud.stack }}rc
                  openstack image create {{ item.name }} --disk-format qcow2 --container-format bare --file /tmp/{{ hostname_url }} --public
              loop:
                - { name: "{{ hostname_url }}" }
                - { name: "{{ hostname_url }}_alt" }

            - name: Upload {{ hostname_url }} image with extra specs
              shell: |
                  source {{ ansible_user_dir }}/{{ install.overcloud.stack }}rc
                  openstack image set {{ hostname_url }} --property {{ item }}
                  openstack image set {{ hostname_url }}_alt --property {{ item }}
              loop: "{{ install.workload.image.get('properties', []) }}"
              when: install.workload.image.properties is defined

            - name: Glance image list
              vars:
                  image_list: []
              set_fact:
                  image_list: "{{ image_list + [ item ] }}"
              loop:
                - "{{ hostname_url }}"
                - "{{ hostname_url }}_alt"

            - name: Create a yaml file containing image names
              copy:
                  content: "{{ image_list | to_nice_yaml(indent=2) }}"
                  dest: "{{ ansible_user_dir }}/post_tasks_glance_images.yml"
        when: install.image is defined
        ignore_errors: yes
